name: Publish Website to CPanel
on:
  push:
    branches:
      - main
      - development
jobs:
  FTP-Deploy-Production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v2.1.0
      with:
        fetch-depth: 2 

    - name: Install lftp
      run: sudo apt-get update && sudo apt-get install -y lftp

    - name: Deploy via SFTP (lftp)
      env:
        FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
        FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        FTP_SERVER: ${{ secrets.FTP_SERVER }}
      run: |
        lftp <<EOF
        set sftp:auto-confirm yes
        set net:timeout 10
        set net:max-retries 3
        open sftp://$FTP_SERVER:22
        user "$FTP_USERNAME" "$FTP_PASSWORD"
        mirror -R -v . ${{ secrets.DEPLOY_PATH_PROD }} \
          --ignore-time \
          --parallel=2 \
          --exclude .git/ \
          --exclude .github/ \
          --exclude node_modules/ \
          --exclude vendor/ \
          --exclude .env \
          --exclude storage/ \
          --exclude public/storage/ \
          --exclude .phpunit.cache \
          --exclude .fleet/ \
          --exclude .idea/ \
          --exclude .vscode/
        quit
        EOF

  # FTP-Deploy-Development:
  #   name: Deploy to Development
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/development'
  #   steps:
  #   - uses: actions/checkout@v2.1.0
  #     with:
  #       fetch-depth: 2 

  #   - name: Install lftp
  #     run: sudo apt-get update && sudo apt-get install -y lftp

  #   - name: Deploy via SFTP (lftp)
  #     env:
  #       FTP_USERNAME: ${{ secrets.FTP_USERNAME_DEV }}
  #       FTP_PASSWORD: ${{ secrets.FTP_PASSWORD_DEV }}
  #       FTP_SERVER: ${{ secrets.FTP_SERVER }}
  #     run: |
  #       lftp <<EOF
  #       set sftp:auto-confirm yes
  #       set net:timeout 10
  #       set net:max-retries 3
  #       open sftp://$FTP_SERVER
  #       user "$FTP_USERNAME" "$FTP_PASSWORD"
  #       mirror -R -v . ${{ secrets.DEPLOY_PATH_DEV }} \
  #         --ignore-time \
  #         --parallel=2 \
  #         --exclude .git/ \
  #         --exclude .github/ \
  #         --exclude node_modules/ \
  #         --exclude vendor/ \
  #         --exclude .env \
  #         --exclude storage/ \
  #         --exclude public/storage/ \
  #         --exclude .phpunit.cache \
  #         --exclude .fleet/ \
  #         --exclude .idea/ \
  #         --exclude .vscode/
  #       quit
  #       EOF

    # - name: Setup SSH Key
    #   run: |
    #     mkdir -p ~/.ssh
    #     echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
    #     chmod 600 ~/.ssh/id_rsa
    #     ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    # # Laravel commands for main (production)
    # - name: SSH Commands - Production
    #   if: github.ref == 'refs/heads/main'
    #   run: |
    #     ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
    #       cd ${{ secrets.DEPLOY_PATH_PROD }}
    #       php artisan down || true
    #       composer install --no-interaction --prefer-dist --optimize-autoloader
    #       composer dump-autoload --optimize
    #       php artisan migrate --force
    #       php artisan config:clear
    #       php artisan cache:clear
    #       php artisan optimize:clear
    #       php artisan config:cache
    #       php artisan route:cache
    #       php artisan view:cache
    #       php artisan up
    #     EOF

    # # Laravel commands for development
    # - name: SSH Commands - Development
    #   if: github.ref == 'refs/heads/development'
    #   run: |
    #     ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
    #       cd ${{ secrets.DEPLOY_PATH_DEV }}
    #       php artisan down || true
    #       composer install --no-interaction --prefer-dist --optimize-autoloader
    #       composer dump-autoload --optimize
    #       php artisan migrate --force
    #       php artisan config:clear
    #       php artisan cache:clear
    #       php artisan optimize:clear
    #       php artisan config:cache
    #       php artisan route:cache
    #       php artisan view:cache
    #       php artisan up
    #     EOF
